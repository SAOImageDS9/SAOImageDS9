prefix		= @prefix@
exec_prefix	= @exec_prefix@

bindir		= @bindir@
libdir		= $(exec_prefix)/lib
#libdir		= @libdir@
includedir	= @includedir@
datarootdir	= @datarootdir@
datadir		= @datadir@
mandir		= @mandir@

OS		= @OS@
ARCH		= @ARCH@
EXEEXT		= @EXEEXT@
JOBS		= @CORES@

#CONFIGFLAGS 	= CC=i686-w64-mingw32-gcc AR=i686-w64-mingw32-ar
CONFIGFLAGS 	= CC=x86_64-w64-mingw32-gcc AR=x86_64-w64-mingw32-ar
ASTFLAGS	= CFLAGS=-DCMINPACK_NO_DLL
XPAFLAGS	= CFLAGS=-DSTATIC_BUILD
TCLXMLFLAGS 	= --with-xml-static=yes
TLSFLAGS	="CFLAGS=-DNO_IDEA=1 -DNO_RC5=1" --with-ssl-dir=$(prefix)/openssl
TARGET		= --build=x86_64-unknown-mingw32

include ./make.include

WITHTCL		= --with-tcl=$(prefix)/tcl$(TCL_VERSION)/win --enable-64bit
WITHTK		= --with-tk=$(prefix)/tk$(TCL_VERSION)/win $(WITHTCL)
CACHE		= --config-cache --cache-file=$(prefix)/config.cache

#--------------------------defines

DS9APP	=SAOImage\ DS9\ $(DS9_VERSION)

#--------------------------build

.PHONY	: saods9 tcl tk tkwin libxml2 libxslt zlib openssl

saods9	: dirs tcl tk \
	libxml2 libxslt zlib openssl \
	tcliis tls tclxml xpa \
	tkblt tktable tkimg \
	tkmpeg tkhtml1 tkcon \
	tkwin \
	tksao ds9
# posix- tclcheckdns tclsignal

# no symbols
tcl	: tcl$(TCL_VERSION)/win/Makefile
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C tcl$(TCL_VERSION)/win -j $(JOBS)
	$(MAKE) -C tcl$(TCL_VERSION)/win install

tcl$(TCL_VERSION)/win/Makefile :
	@echo ""
	@echo "*** $@ ***"
	cd tcl$(TCL_VERSION)/win; \
	./configure \
	--enable-64bit \
	--prefix $(prefix) --exec-prefix $(exec_prefix) --libdir $(libdir) \
	--disable-shared \
	--config-cache --cache-file=$(prefix)/config.cache

tk	: tk$(TCL_VERSION)/win/Makefile
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C tk$(TCL_VERSION)/win -j $(JOBS) install

tk$(TCL_VERSION)/win/Makefile :
	@echo ""
	@echo "*** $@ ***"
	cd tk$(TCL_VERSION)/win; \
	./configure \
	$(WITHTCL) \
	$(TKFLAGS) \
	--prefix $(prefix) --exec-prefix $(exec_prefix) --libdir $(libdir) \
	--disable-shared --enable-symbols

tkwin: tkwin/Makefile
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C tkwin install

tkwin/Makefile :
	@echo ""
	@echo "*** $@ ***"
	cd tkwin; \
	./configure \
	$(WITHTK) \
	--prefix $(prefix) --exec-prefix $(exec_prefix) \
	--disable-shared --enable-symbols \
	--config-cache --cache-file=$(prefix)/config.cache

libxml2 : libxml2/win32/config.mingw
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxml2/win32 -j $(JOBS) -f Makefile.mingw dep
	$(MAKE) -C libxml2/win32 -j $(JOBS) -f Makefile.mingw libxmla
	$(MAKE) -C libxml2/win32 -j $(JOBS) -f Makefile.mingw install-libsa
	cp libxml2/win32/xml2-config $(bindir)

libxml2/win32/config.mingw :
	@echo ""
	@echo "*** $@ ***"
	cd libxml2/win32; \
	cscript configure.js trio=no threads=no ftp=yes http=yes html=yes c14n=yes catalog=yes docb=yes xpath=yes xptr=yes xinclude=yes iconv=no icu=no iso8859x=no zlib=no lzma=no xml_debug=yes mem_debug=yes run_debug=no regexps=yes modules=no tree=yes reader=yes writer=yes walker=yes pattern=yes push=yes valid=yes sax1=yes legacy=yes output=yes schemas=yes schematron=yes python=no compiler=mingw static=yes prefix="..\.." bindir="..\..\bin" incdir="..\..\include" libdir="..\..\lib"

libxslt : libxslt/win32/config.mingw
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxslt/win32 -j $(JOBS) -f Makefile.mingw dep
	$(MAKE) -C libxslt/win32 -j $(JOBS) -f Makefile.mingw libxslta
	$(MAKE) -C libxslt/win32 -j $(JOBS) -f Makefile.mingw libexslta
	$(MAKE) -C libxslt/win32 -j $(JOBS) -f Makefile.mingw install-libsa
	cp libxslt/win32/xslt-config $(bindir)

libxslt/win32/config.mingw :
	@echo ""
	@echo "*** $@ ***"
	cd libxslt/win32; \
	cscript configure.js trio=no xslt_debug=yes mem_debug=no debugger=yes iconv=no zlib=no crypto=yes modules=no locale=yes compiler=mingw static=yes prefix="..\.." bindir="..\..\bin" incdir="..\..\include" libdir="..\..\lib"

# must force Makefile
zlib	: zlib_Makefile
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C zlib -j $(JOBS) install

zlib_Makefile :
	@echo ""
	@echo "*** $@ ***"
	cd zlib; \
	$(CONFIGFLAGS) CFLAGS=-DSTATIC_BUILD=1 ./configure \
	--prefix $(prefix) -eprefix $(exec_prefix) --libdir $(libdir) \
	--static

openssl	: openssl/Makefile
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C openssl -j $(JOBS)

openssl/Makefile:
	@echo ""
	@echo "*** $@ ***"
	cd openssl; \
	export CROSS_COMPILE=x86_64-w64-mingw32-; \
	./Configure mingw64 --prefix=$(prefix) shared no-asm

#--------------------------clean

.PHONY	: tkwinclean libxml2clean libxsltclean zlibclean opensslclean

tkwinclean : libxml2clean libxsltclean zlibclean opensslclean
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C tkwin clean

libxml2clean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxml2/win32 -f Makefile.mingw clean

libxsltclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxslt/win32 -f Makefile.mingw clean

zlibclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C zlib clean

opensslclean:
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C openssl clean

#--------------------------distclean

.PHONY	: tkwindistclean libxml2distclean libxsltdistclean zlibdistclean openssldistclean

tkwindistclean : libxml2distclean libxsltdistclean zlibdistclean openssldistclean
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C tkwin distclean

libxml2distclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxml2/win32 -f Makefile.mingw distclean

libxsltdistclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C libxslt/win32 -f Makefile.mingw distclean

zlibdistclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C zlib distclean
	rm -f zlib/Makefile

openssldistclean :
	@echo ""
	@echo "*** $@ ***"
	$(MAKE) -C openssl clean
	rm -f openssl/Makefile

#--------------------------distribution

.PHONY	: dist

dist	:
	$(RM) -f dist/$(DS9APP)\ Install.*
	/cygdrive/c/Program\ Files\ \(x86\)/WinZip/wzzip -p -r dist/$(DS9APP)\ Install.zip bin/ds9app
	/cygdrive/c/Program\ Files\ \(x86\)/WinZip\ Self-Extractor/WINZIPSE.EXE  dist/$(DS9APP)\ Install.zip -d "C:\SAOImage DS9" -i ds9/win/ds9.ico -le -overwrite -runasuser -c cscript install.vbs

