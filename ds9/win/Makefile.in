prefix		= @prefix@
exec_prefix	= @exec_prefix@

bindir		= @bindir@
libdir		= $(exec_prefix)/lib
#libdir		= @libdir@
includedir	= @includedir@
datarootdir	= @datarootdir@
datadir		= @datadir@
mandir		= @mandir@

TCLSH_PROG	= @TCLSH_PROG@

TCL_VERSION	= @TCL_VERSION@
TCL_LIB_SPEC	= @TCL_LIB_SPEC@
TCL_STUB_LIB_SPEC= @TCL_STUB_LIB_SPEC@
TK_LIBS		= @TK_LIBS@
TK_LIB_SPEC	= @TK_LIB_SPEC@
TK_STUB_LIB_SPEC= @TK_STUB_LIB_SPEC@

tifftcl_LIB_SPEC= @tifftcl_LIB_SPEC@
pngtcl_LIB_SPEC	= @pngtcl_LIB_SPEC@
jpegtcl_LIB_SPEC= @jpegtcl_LIB_SPEC@
zlibtcl_LIB_SPEC= @zlibtcl_LIB_SPEC@

tkimg_LIB_SPEC	= @tkimg_LIB_SPEC@
tkimggif_LIB_SPEC= @tkimggif_LIB_SPEC@
tkimgjpeg_LIB_SPEC= @tkimgjpeg_LIB_SPEC@
tkimgpng_LIB_SPEC= @tkimgpng_LIB_SPEC@
tkimgtiff_LIB_SPEC= @tkimgtiff_LIB_SPEC@
tkimgwindow_LIB_SPEC= @tkimgwindow_LIB_SPEC@

tclxml_LIB_SPEC	= @tclxml_LIB_SPEC@

tkblt_LIB_SPEC	= @tkblt_LIB_SPEC@
tkhtml1_LIB_SPEC= @tkhtml1_LIB_SPEC@
tkmpeg_LIB_SPEC	= @tkmpeg_LIB_SPEC@
tksao_LIB_SPEC	= @tksao_LIB_SPEC@
tktable_LIB_SPEC= @tktable_LIB_SPEC@
tkwin_LIB_SPEC	= @tkwin_LIB_SPEC@

CC		= @CC@
CFLAGS_DEFAULT	= @CFLAGS_DEFAULT@
CFLAGS_WARNING	= @CFLAGS_WARNING@
EXEEXT		= @EXEEXT@
OBJEXT		= @OBJEXT@

INCLUDES	= @PKG_INCLUDES@ @TCL_INCLUDES@ @TK_INCLUDES@ @TK_XINCLUDES@

PKG_CFLAGS	= @PKG_CFLAGS@
DEFS		= @DEFS@ $(PKG_CFLAGS)

CPPFLAGS	= @CPPFLAGS@
LIBS		= @PKG_LIBS@ @LIBS@
CFLAGS		= @CFLAGS@
COMPILE		= $(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS)

STRIP		= i686-w64-mingw32-strip.exe

.SUFFIXES: .c .C .$(OBJEXT)

.c.@OBJEXT@:
	$(COMPILE) -DSTATIC_BUILD -c $< -o $@

.C.@OBJEXT@:
	$(COMPILE) -DSTATIC_BUILD -c $< -o $@

#--------------------------defines

APPDIR	= $(bindir)/ds9app
LIBDIR	= $(APPDIR)

OBJS	= ds9.o winMain.o ds9.res.o

#--------------------------main

.NOTPARALLEL :
.PHONY	: ds9 debug appdir framework frame2 tcltk tcllib tkcon tkblt xpa cleanup

ds9	: ds9Base$(EXEEXT) appdir framework frame2 tcltk tcllib tkcon tkblt xpa cleanup
	cp -p ds9base$(EXEEXT) ds9$(EXEEXT)
	$(STRIP) ds9$(EXEEXT)
	cp -p ds9$(EXEEXT) $(APPDIR)/.

debug	: ds9Base$(EXEEXT) appdir framework frame2 tcltk tcllib tkcon tkblt cleanup
	mv ds9base$(EXEEXT) ds9$(EXEEXT)
	cp -p ds9$(EXEEXT) $(APPDIR)/.

ds9Base$(EXEEXT): $(OBJS)
	$(RM) $@
	$(CC) $(CFLAGS)	-o $@ \
	$(OBJS) \
	$(tksao_LIB_SPEC) \
	$(libdir)/libfuntools.a \
	$(libdir)/libast.a \
	$(libdir)/libast_err.a \
	$(libdir)/libast_pal.a \
	$(libdir)/libxpa.a \
	$(libdir)/libxml2.a \
	$(libdir)/libz.a \
	$(jpegtcl_LIB_SPEC) \
	$(pngtcl_LIB_SPEC) \
	$(tifftcl_LIB_SPEC) \
	$(zlibtcl_LIB_SPEC) \
	$(tclxml_LIB_SPEC) \
	$(tkblt_LIB_SPEC) \
	$(tkhtml1_LIB_SPEC) \
	$(tkimg_LIB_SPEC) \
	$(tkimggif_LIB_SPEC) \
	$(tkimgjpeg_LIB_SPEC) \
	$(tkimgpng_LIB_SPEC) \
	$(tkimgtiff_LIB_SPEC) \
	$(tkimgwindow_LIB_SPEC) \
	$(tkmpeg_LIB_SPEC) \
	$(tksao_LIB_SPEC) \
	$(tktable_LIB_SPEC) \
	$(tkwin_LIB_SPEC) \
	$(TK_STUB_LIB_SPEC) $(TK_LIB_SPEC) \
	$(TCL_STUB_LIB_SPEC) $(TCL_LIB_SPEC) \
	$(TK_LIBS) \
	$(LIBS) \
	-mwindows -static

winMain.o : winMain.c
	$(COMPILE) \
	-DSTATIC_BUILD \
	-DTK_LOCAL_APPINIT=SAOAppInit -DTK_LOCAL_MAIN_HOOK=SAOLocalMainHook \
	-c winMain.c -o $@

winMain.c : $(prefix)/tk$(TCL_VERSION)/win/winMain.c
	cp $(prefix)/tk$(TCL_VERSION)/win/winMain.c .

ds9.res.o: ds9.rc ds9.ico
	i686-w64-mingw32-windres -o $@ \
	--define STATIC_BUILD --include $(prefix)/tk$(TCL_VERSION)/generic \
	--include $(prefix)/$(TCLDIR)/generic --include $(prefix)/tk$(TCL_VERSION)/win/rc \
	ds9.rc

include ../make.include

appdir	:
	rm -rf $(APPDIR)
	mkdir $(APPDIR)

frame2:
	cp install.vbs $(APPDIR)/.

tcltk	:
	cp -pr $(prefix)/lib/tcl8 $(APPDIR)/.
	cp -pr $(prefix)/lib/tcl8.6 $(APPDIR)/.
	cp -pr $(prefix)/lib/tk8.6 $(APPDIR)/.

tcllib	:
	cp -pr $(prefix)/tcllib/modules/base64 $(APPDIR)/.
	cp -pr $(prefix)/tcllib/modules/ftp $(APPDIR)/.
	cp -pr $(prefix)/tcllib/modules/log $(APPDIR)/.
	cp -pr $(prefix)/tcllib/modules/textutil $(APPDIR)/.
	cp -pr $(prefix)/tcllib/modules/math $(APPDIR)/.

xpa	:
	cp -p $(bindir)/xpans.exe $(APPDIR)/.

cleanup:
	cd $(APPDIR); find . -depth -name CVS -exec rm -rf {} \;

#--------------------------cleanup

.PHONY	: clean distclean

clean	:
	cd ../library; $(MAKE) clean
	$(RM) core *~ *# ds9Base ds9 *.o

distclean: clean
	-rm -f Makefile config.cache config.log config.status
	-rm -rf autom4te.cache
